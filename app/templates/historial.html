<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestor Documental - Historial de Documento</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background: #f8f9fa;
            font-family: Arial, sans-serif;
            padding-top: 80px;
        }
        .container {
            max-width: 800px;
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 0 12px rgba(0,0,0,0.1);
        }
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #0d6efd;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .header .usuario {
            font-weight: bold;
        }
        .header button {
            color: #fff;
            border: none;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
        }
        .header button:hover {
            background: rgba(255,255,255,0.35);
        }
    </style>
</head>
<body>

<!-- HEADER (id√©ntico al de documentos y versiones) -->
<div class="header" id="header-bar" style="display: none;">
    <div>
        <button id="back-btn" class="me-2">‚¨Ö Volver</button>
        <span class="usuario" id="usuario-info-header"></span>
    </div>
    <button id="logout-btn">Cerrar sesi√≥n</button>
</div>

<!-- CONTENIDO PRINCIPAL -->
<div class="container">
    <h3 class="text-center mb-4">üìú Historial de Documento</h3>

    <!-- LOGIN -->
    <div id="login-section">
        <h5>Iniciar sesi√≥n</h5>
        <form id="login-form">
            <div class="mb-3">
                <label for="email" class="form-label">Correo electr√≥nico</label>
                <input type="text" class="form-control" id="email" placeholder="usuario@correo.com" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Contrase√±a</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Iniciar sesi√≥n</button>
        </form>
    </div>

    <!-- CONSULTA DE HISTORIAL -->
    <div id="historial-section" style="display: none;">
        <div id="usuario-info" class="mb-3"></div>

        <form id="historial-form" class="mb-4">
            <div class="input-group">
                <input type="text" id="nombre-archivo" class="form-control" placeholder="Nombre del archivo (ej: Taller 2.pdf)" required>
                <button class="btn btn-primary" type="submit">Buscar Historial</button>
            </div>
        </form>

        <div id="resultado"></div>
    </div>
</div>

<script>
const API_BASE = "http://127.0.0.1:8000";
let token = localStorage.getItem("access_token");
let usuarioActual = localStorage.getItem("usuario_nombre");

// Mostrar secci√≥n correcta
if (token) {
    document.getElementById("login-section").style.display = "none";
    document.getElementById("historial-section").style.display = "block";
    document.getElementById("header-bar").style.display = "flex";
    document.getElementById("usuario-info").innerHTML = `üîí Sesi√≥n activa como: <strong>${usuarioActual}</strong>`;
    document.getElementById("usuario-info-header").innerText = `Conectado como ${usuarioActual}`;
}

// --- LOGIN ---
document.getElementById("login-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData();
    formData.append("email", document.getElementById("email").value);
    formData.append("password", document.getElementById("password").value);

    const resp = await fetch(`${API_BASE}/auth/login`, {
        method: "POST",
        body: formData
    });

    const data = await resp.json();
    if (resp.ok) {
        localStorage.setItem("access_token", data.access_token);
        localStorage.setItem("usuario_nombre", data.usuario);
        token = data.access_token;
        usuarioActual = data.usuario;

        alert(`‚úÖ Bienvenido, ${usuarioActual}`);
        document.getElementById("login-section").style.display = "none";
        document.getElementById("historial-section").style.display = "block";
        document.getElementById("header-bar").style.display = "flex";
        document.getElementById("usuario-info").innerHTML = `üîí Sesi√≥n activa como: <strong>${usuarioActual}</strong>`;
        document.getElementById("usuario-info-header").innerText = `Conectado como ${usuarioActual}`;
    } else {
        alert(data.detail || "Error al iniciar sesi√≥n");
    }
});

// --- CONSULTA HISTORIAL ---
document.getElementById("historial-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const nombreArchivo = document.getElementById("nombre-archivo").value.trim();
    const resultado = document.getElementById("resultado");

    if (!nombreArchivo) {
        resultado.innerHTML = `<div class="alert alert-warning">Por favor ingrese el nombre del archivo.</div>`;
        return;
    }

    const resp = await fetch(`${API_BASE}/documentos/historial?nombre_archivo=${encodeURIComponent(nombreArchivo)}`, {
        headers: { "Authorization": `Bearer ${token}` }
    });

    const data = await resp.json();

    if (resp.ok) {
        if (data.historial && data.historial.length > 0) {
            resultado.innerHTML = `
                <div class="alert alert-info">
                    <strong>${nombreArchivo}</strong> tiene ${data.historial.length} versi√≥n(es).
                </div>
                <table class="table table-bordered mt-3">
                    <thead class="table-primary">
                        <tr><th>#</th><th>Versi√≥n</th><th>Fecha de Subida</th><th>Usuario</th></tr>
                    </thead>
                    <tbody>
                        ${data.historial.map((v, i) => `
                            <tr>
                                <td>${i + 1}</td>
                                <td>${v.version || '-'}</td>
                                <td>${v.fecha_subida || '-'}</td>
                                <td>${v.usuario || '-'}</td>
                            </tr>
                        `).join("")}
                    </tbody>
                </table>
            `;
        } else {
            resultado.innerHTML = `<div class="alert alert-warning">No hay historial disponible para <strong>${nombreArchivo}</strong>.</div>`;
        }
    } else {
        resultado.innerHTML = `<div class="alert alert-danger">‚ö†Ô∏è Error: ${data.detail || "No se pudo obtener el historial."}</div>`;
    }
});

// --- LOGOUT ---
document.getElementById("logout-btn").addEventListener("click", () => {
    localStorage.removeItem("access_token");
    localStorage.removeItem("usuario_nombre");
    location.reload();
});

// --- VOLVER AL DASHBOARD ---
document.getElementById("back-btn").addEventListener("click", () => {
    window.location.href = "/dashboard";
});
</script>

</body>
</html>
