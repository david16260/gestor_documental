<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestor Documental - Subida por URL + FUID Autom√°tico</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background: #f8f9fa; font-family: Arial, sans-serif; padding-top: 80px; }
        .container { max-width: 700px; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 0 12px rgba(0,0,0,0.1); }
        .resultado { margin-top: 20px; }
        .header { position: fixed; top: 0; left: 0; width: 100%; background: #0d6efd; color: white; display: flex; justify-content: space-between; align-items: center; padding: 10px 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; }
        .header .usuario { font-weight: bold; }
        .header button { color: #fff; border: none; background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 6px; cursor: pointer; }
        .header button:hover { background: rgba(255,255,255,0.35); }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        .info-box { background: #f1f5ff; border-left: 4px solid #0d6efd; padding: 10px; font-size: 0.9em; border-radius: 8px; display: none; margin-top: 5px; }
        .success-badge { background: #d1edff; color: #0d6efd; padding: 8px 12px; border-radius: 6px; font-weight: bold; }
    </style>
</head>
<body>

<div class="header" id="header-bar" style="display: none;">
    <div>
        <button id="back-btn" class="me-2">‚¨Ö Volver</button>
        <span class="usuario" id="usuario-info-header"></span>
    </div>
    <button id="logout-btn">Cerrar sesi√≥n</button>
</div>

<div class="container">
    <h3 class="text-center mb-4">üìÑ Subir Documento por URL + FUID Autom√°tico</h3>

    <!-- Login r√°pido -->
    <div id="login-section">
        <h5>Iniciar sesi√≥n</h5>
        <form id="login-form">
            <div class="mb-3">
                <label for="email" class="form-label">Correo electr√≥nico</label>
                <input type="text" class="form-control" id="email" placeholder="usuario@correo.com" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Contrase√±a</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Iniciar sesi√≥n</button>
        </form>
    </div>

    <!-- Subida por URL -->
    <div id="upload-section" style="display: none;">
        <div id="usuario-info" class="mb-3"></div>
        
        <form id="upload-form">
            <div class="mb-3">
                <label for="url" class="form-label">Pega la URL p√∫blica (Drive, OneDrive o enlace directo)</label>
                <input type="url" class="form-control" id="url" placeholder="https://drive.google.com/file/d/..." required>
            </div>
            
            <!-- Expediente ID autom√°tico (oculto) -->
            <div style="display: none;">
                <input type="hidden" id="expediente_id" value="1">
            </div>

            <div class="mb-3">
                <label for="version" class="form-label">Versi√≥n</label>
                <input type="text" class="form-control" id="version" name="version" placeholder="Ej: 1.0" value="1.0">
            </div>
            
            <button type="submit" id="submit-btn" class="btn btn-success w-100">
                <span id="btn-text">Subir Documento y Generar FUID</span>
                <div id="btn-loading" style="display: none;">
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                    Procesando...
                </div>
            </button>
        </form>

        <!-- Bot√≥n para generar √≠ndice foliado -->
        <div class="mt-3">
            <button id="btn-indice" class="btn btn-primary w-100">üìã Generar √≠ndice foliado</button>
        </div>

        <div id="indice-resultado" class="mt-3"></div>

        <div class="resultado" id="resultado"></div>
    </div>
</div>

<script>
const API_BASE = "http://127.0.0.1:8000";
let token = localStorage.getItem("access_token");
let usuarioActual = localStorage.getItem("usuario_nombre");

function showLoggedInState() {
    document.getElementById("login-section").style.display = "none";
    document.getElementById("upload-section").style.display = "block";
    document.getElementById("header-bar").style.display = "flex";
    document.getElementById("usuario-info").innerHTML = `üîí Sesi√≥n activa como: <strong>${usuarioActual}</strong>`;
    document.getElementById("usuario-info-header").innerText = `Conectado como ${usuarioActual}`;
}

if (token) {
    showLoggedInState();
}

// --- LOGIN ---
document.getElementById("login-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    submitBtn.disabled = true;
    submitBtn.textContent = "Iniciando sesi√≥n...";

    const formData = new FormData();
    formData.append("username", document.getElementById("email").value);
    formData.append("password", document.getElementById("password").value);

    try {
        const resp = await fetch(`${API_BASE}/auth/login`, {
            method: "POST",
            body: formData
        });

        const data = await resp.json();
        if (resp.ok) {
            localStorage.setItem("access_token", data.access_token);
            localStorage.setItem("usuario_nombre", data.usuario);
            token = data.access_token;
            usuarioActual = data.usuario;
            showLoggedInState();
        } else {
            alert(data.detail || "Error al iniciar sesi√≥n");
        }
    } catch (error) {
        alert("Error de conexi√≥n: " + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
});

// --- SUBIR POR URL CON INTEGRACI√ìN FLUID ---
document.getElementById("upload-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const url = document.getElementById("url").value.trim();
    
    if (!url) {
        alert("Ingresa una URL v√°lida");
        return;
    }
    
    // EXPEDIENTE_ID AUTOM√ÅTICO (n√∫mero m√°s peque√±o)
    const expediente_id = Math.floor(Date.now() / 1000);
    let version = document.getElementById("version").value.trim() || "1.0";

    // MOSTRAR LOADING
    const submitBtn = document.getElementById("submit-btn");
    const btnText = document.getElementById("btn-text");
    const btnLoading = document.getElementById("btn-loading");
    
    submitBtn.disabled = true;
    btnText.style.display = "none";
    btnLoading.style.display = "block";

    try {
        // Intentar primero con el endpoint de integraci√≥n FUID
        const params = new URLSearchParams({
            url: url,
            expediente_id: expediente_id.toString(),
            version: version
        });

        const resp = await fetch(`${API_BASE}/integracion/procesar-url?${params}`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${token}`
            }
        });

        const data = await resp.json();
        const resultado = document.getElementById("resultado");

        if (resp.ok) {
            // √âXITO - Mostrar informaci√≥n combinada (original + FUID)
            let successHTML = `
                <div class="alert alert-success">
                    <h5>‚úÖ ${data.mensaje || "Documento procesado exitosamente"}</h5>
                    <div class="success-badge mb-3">FUID GENERADO AUTOM√ÅTICAMENTE</div>
            `;

            // INFORMACI√ìN DEL DOCUMENTO (respuesta original)
            if (data.documento) {
                const doc = data.documento;
                successHTML += `
                    <strong>üìÑ Archivo Procesado:</strong><br>
                    - <strong>ID:</strong> ${doc.id} <br>
                    - <strong>Nombre:</strong> ${doc.nombre} <br>
                    - <strong>Extensi√≥n:</strong> ${doc.extension} <br>
                    - <strong>Versi√≥n:</strong> ${doc.version} <br>
                    - <strong>Tama√±o:</strong> ${doc.tamano_kb} KB <br>
                    - <strong>Ruta:</strong> <code>${doc.ruta_guardado}</code> <br>
                    - <strong>Duplicado:</strong> ${doc.duplicado ? 'S√≠' : 'No'} <br>
                `;
            }

            // INFORMACI√ìN DEL FUID (nueva)
            if (data.fuid_generado) {
                const fuid = data.fuid_generado;
                successHTML += `
                    <hr>
                    <strong>üìã FUID Generado:</strong><br>
                    - <strong>N√∫mero:</strong> ${fuid.numero_fuid} <br>
                    - <strong>ID FUID:</strong> ${fuid.id_fuid} <br>
                    - <strong>Hash:</strong> <code>${fuid.hash_fuid}</code> <br>
                    - <strong>Expediente ID:</strong> ${fuid.expediente_id} <br>
                    - <strong>Fecha:</strong> ${new Date(fuid.fecha_generacion).toLocaleString()} <br>
                `;
            }

            // METADATOS ADICIONALES (respuesta original)
            if (data.metadatos_extra && Object.keys(data.metadatos_extra).length > 0) {
                successHTML += `
                    <hr>
                    <strong>üìä Metadatos adicionales:</strong>
                    <pre class="mt-2 p-2 bg-light border rounded">${JSON.stringify(data.metadatos_extra, null, 2)}</pre>
                `;
            }

            // CLASIFICACI√ìN DOCUMENTAL (si existe)
            if (data.clasificacion) {
                const clasif = data.clasificacion;
                successHTML += `
                    <hr>
                    <strong>üóÇ Clasificaci√≥n Documental:</strong><br>
                    - <strong>Tipo:</strong> ${clasif.tipo_documento || '-'} <br>
                    - <strong>Categor√≠a:</strong> ${clasif.categoria || '-'} <br>
                    - <strong>Confidencialidad:</strong> ${clasif.confidencialidad || '-'} <br>
                    - <strong>Autor:</strong> ${clasif.autor || '-'} <br>
                `;
            }

            successHTML += `</div>`;
            resultado.innerHTML = successHTML;

            // Limpiar formulario despu√©s de √©xito
            document.getElementById("url").value = "";
            
        } else {
            // Si falla el endpoint de integraci√≥n, intentar con el endpoint original
            console.log("Endpoint de integraci√≥n fall√≥, intentando con endpoint original...");
            
            const respOriginal = await fetch(`${API_BASE}/documentos/desde-url`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ url, version })
            });

            const dataOriginal = await respOriginal.json();
            
            if (respOriginal.ok) {
                const doc = dataOriginal.documento || {};
                const extra = dataOriginal.metadatos_extra || {};
                const clasificacion = dataOriginal.clasificacion || {};

                resultado.innerHTML = `
                    <div class="alert alert-success">
                        ‚úÖ ${dataOriginal.mensaje}<br>
                        <strong>ID:</strong> ${doc.id} <br>
                        <strong>Nombre:</strong> ${doc.nombre} <br>
                        <strong>Extensi√≥n:</strong> ${doc.extension} <br>
                        <strong>Tama√±o (KB):</strong> ${doc.tamano_kb} <br>
                        <strong>Duplicado:</strong> ${doc.duplicado} <br>
                        <strong>Ruta:</strong> <code>${doc.ruta_guardado}</code>
                        <hr>
                        <strong>Metadatos adicionales:</strong>
                        <pre>${JSON.stringify(extra, null, 2)}</pre>
                        <hr>
                        <strong>Clasificaci√≥n:</strong><br>
                        - <strong>Tipo:</strong> ${clasificacion.tipo_documento || '-'}<br>
                        - <strong>Categor√≠a:</strong> ${clasificacion.categoria || '-'}<br>
                        - <strong>Confidencialidad:</strong> ${clasificacion.confidencialidad || '-'}<br>
                        - <strong>Autor:</strong> ${clasificacion.autor || '-'}
                    </div>
                `;
            } else {
                // ERROR
                let errorMsg = data.detail || dataOriginal.detail || "Error desconocido del servidor";
                if (typeof errorMsg === 'object') {
                    errorMsg = JSON.stringify(errorMsg, null, 2);
                }
                
                resultado.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>‚ùå Error ${resp.status || respOriginal.status}</h5>
                        <p>${errorMsg}</p>
                    </div>
                `;
            }
        }
    } catch (error) {
        document.getElementById("resultado").innerHTML = `
            <div class="alert alert-danger">
                <h5>üö® Error de conexi√≥n</h5>
                <p>${error.message}</p>
                <small>Verifica que el servidor est√© ejecut√°ndose en ${API_BASE}</small>
            </div>
        `;
    } finally {
        // RESTAURAR BOT√ìN
        submitBtn.disabled = false;
        btnText.style.display = "block";
        btnLoading.style.display = "none";
    }
});

// --- LOGOUT ---
document.getElementById("logout-btn").addEventListener("click", () => {
    if (confirm("¬øEst√°s seguro de que quieres cerrar sesi√≥n?")) {
        localStorage.removeItem("access_token");
        localStorage.removeItem("usuario_nombre");
        location.reload();
    }
});

// --- VOLVER AL DASHBOARD ---
document.getElementById("back-btn").addEventListener("click", () => {
    window.location.href = "/dashboard";
});

// --- ENTER para submit ---
document.getElementById("url").addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
        e.preventDefault();
        document.getElementById("upload-form").dispatchEvent(new Event("submit"));
    }
});

// --- GENERAR √çNDICE FOLIADO ---
document.getElementById("btn-indice").addEventListener("click", async () => {
    if (!token) {
        alert('Debes iniciar sesi√≥n para generar el √≠ndice foliado');
        return;
    }

    const resultadoCont = document.getElementById('indice-resultado');
    resultadoCont.innerHTML = '<div class="alert alert-info">Generando √≠ndice foliado...</div>';

    try {
        const resp = await fetch(`${API_BASE}/documentos/indice_foliado`, {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!resp.ok) {
            const err = await resp.json();
            resultadoCont.innerHTML = `<div class="alert alert-danger">Error: ${err.detail || resp.statusText}</div>`;
            return;
        }

        const data = await resp.json();

        // Construir tabla HTML con el √≠ndice
        let html = `
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">√çndice foliado (usuario ${data.usuario_id})</h5>
                    <p>Total documentos: <strong>${data.total_documentos}</strong> ‚Äî Total p√°ginas estimadas: <strong>${data.total_paginas}</strong></p>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead><tr><th>Orden</th><th>Documento</th><th>Tama√±o (KB)</th><th>Inicio</th><th>Fin</th><th>Fecha</th></tr></thead>
                            <tbody>
        `;

        for (const fila of data.indice) {
            html += `<tr><td>${fila.orden}</td><td>${fila.nombre_archivo}</td><td>${fila.tamano_kb}</td><td>${fila.pagina_inicio}</td><td>${fila.pagina_fin}</td><td>${fila.fecha || '-'}</td></tr>`;
        }

        html += `</tbody></table></div>`;

        // Botones: descargar CSV
        html += `<div class="mt-2"><button id="descargar-csv" class="btn btn-outline-primary btn-sm">Descargar CSV</button></div>`;
        html += `</div></div>`;

        resultadoCont.innerHTML = html;

        document.getElementById('descargar-csv').addEventListener('click', async () => {
            // Solicitar CSV y forzar descarga
            const respCsv = await fetch(`${API_BASE}/documentos/indice_foliado?formato=csv`, {
                method: 'GET', headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!respCsv.ok) {
                const err = await respCsv.text();
                alert('Error al generar CSV: ' + err);
                return;
            }

            const blob = await respCsv.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `indice_foliado_user_${localStorage.getItem('usuario_nombre') || 'user'}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
        });

    } catch (error) {
        resultadoCont.innerHTML = `<div class="alert alert-danger">Error de conexi√≥n: ${error.message}</div>`;
    }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>