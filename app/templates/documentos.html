<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestor Documental - Subida por URL</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background: #f8f9fa; font-family: Arial, sans-serif; padding-top: 80px; }
        .container { max-width: 700px; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 0 12px rgba(0,0,0,0.1); }
        .resultado { margin-top: 20px; }
        .header { position: fixed; top: 0; left: 0; width: 100%; background: #0d6efd; color: white; display: flex; justify-content: space-between; align-items: center; padding: 10px 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; }
        .header .usuario { font-weight: bold; }
        .header button { color: #fff; border: none; background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 6px; cursor: pointer; }
        .header button:hover { background: rgba(255,255,255,0.35); }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        .info-box { background: #f1f5ff; border-left: 4px solid #0d6efd; padding: 10px; font-size: 0.9em; border-radius: 8px; display: none; margin-top: 5px; }
    </style>
</head>
<body>

<div class="header" id="header-bar" style="display: none;">
    <div>
        <button id="back-btn" class="me-2">‚¨Ö Volver</button>
        <span class="usuario" id="usuario-info-header"></span>
    </div>
    <button id="logout-btn"></button>
</div>

<div class="container">
    <h3 class="text-center mb-4">üìÑ Subir Documento por URL</h3>

    <!-- Login r√°pido -->
    <div id="login-section">
        <h5>Iniciar sesi√≥n</h5>
        <form id="login-form">
            <div class="mb-3">
                <label for="email" class="form-label">Correo electr√≥nico</label>
                <input type="text" class="form-control" id="email" placeholder="usuario@correo.com" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Contrase√±a</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Iniciar sesi√≥n</button>
        </form>
    </div>

    <!-- Subida por URL -->
    <div id="upload-section" style="display: none;">
        <div id="usuario-info" class="mb-3"></div>
        <form id="upload-form">
            <div class="mb-3">
                <label for="url" class="form-label">Pega la URL p√∫blica (Drive, OneDrive o enlace directo)</label>
                <input type="url" class="form-control" id="url" placeholder="https://drive.google.com/file/d/..." required>
            </div>
            <div class="mb-3">
                <label for="version" class="form-label">Versi√≥n</label>
                <input type="text" class="form-control" id="version" name="version" placeholder="Ej: 1.0">
            </div>
            <button type="submit" id="submit-btn" class="btn btn-success w-100">Subir Documento</button>
        </form>

        <div class="resultado" id="resultado"></div>
    </div>
</div>

<script>
const API_BASE = "http://127.0.0.1:8000";
let token = localStorage.getItem("access_token");
let usuarioActual = localStorage.getItem("usuario_nombre");

function showLoggedInState() {
    document.getElementById("login-section").style.display = "none";
    document.getElementById("upload-section").style.display = "block";
    document.getElementById("header-bar").style.display = "flex";
    document.getElementById("usuario-info").innerHTML = `üîí Sesi√≥n activa como: <strong>${usuarioActual}</strong>`;
    document.getElementById("usuario-info-header").innerText = `Conectado como ${usuarioActual}`;
}

if (token) {
    showLoggedInState();
}

// --- LOGIN ---
document.getElementById("login-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData();
    formData.append("username", document.getElementById("email").value);
    formData.append("password", document.getElementById("password").value);

    const resp = await fetch(`${API_BASE}/auth/login`, {
        method: "POST",
        body: formData
    });

    const data = await resp.json();
    if (resp.ok) {
        localStorage.setItem("access_token", data.access_token);
        localStorage.setItem("usuario_nombre", data.usuario);
        token = data.access_token;
        usuarioActual = data.usuario;
        alert(`‚úÖ Bienvenido, ${usuarioActual}`);
        showLoggedInState();
    } else {
        alert(data.detail || "Error al iniciar sesi√≥n");
    }
});

// --- SUBIR POR URL ---
document.getElementById("upload-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const url = document.getElementById("url").value.trim();
    if (!url) {
        alert("Ingresa una URL v√°lida");
        return;
    }
    let version = document.getElementById("version").value.trim() || "1.0";

    const resp = await fetch(`${API_BASE}/documentos/desde-url`, {
        method: "POST",
        headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ url, version })
    });

    const data = await resp.json();
    const resultado = document.getElementById("resultado");

    if (resp.ok) {
        const doc = data.documento || {};
        const extra = data.metadatos_extra || {};
        const clasificacion = data.clasificacion || {};

        resultado.innerHTML = `
            <div class="alert alert-success">
                ‚úÖ ${data.mensaje}<br>
                <strong>ID:</strong> ${doc.id} <br>
                <strong>Nombre:</strong> ${doc.nombre} <br>
                <strong>Extensi√≥n:</strong> ${doc.extension} <br>
                <strong>Tama√±o (KB):</strong> ${doc.tamano_kb} <br>
                <strong>Duplicado:</strong> ${doc.duplicado} <br>
                <strong>Ruta:</strong> <code>${doc.ruta_guardado}</code>
                <hr>
                <strong>Metadatos adicionales:</strong>
                <pre>${JSON.stringify(extra, null, 2)}</pre>

                <hr>
                <div class="accordion mt-3" id="clasificacionAccordion">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="clasificacionHeading">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#clasificacionCollapse" aria-expanded="false" aria-controls="clasificacionCollapse">
                        üóÇ Clasificar Documento (opcional)
                      </button>
                    </h2>
                    <div id="clasificacionCollapse" class="accordion-collapse collapse" aria-labelledby="clasificacionHeading" data-bs-parent="#clasificacionAccordion">
                      <div class="accordion-body">
                        <form id="editar-clasificacion-form" class="row g-3">
                            <input type="hidden" id="doc-id-edit" value="${doc.id}">
                            
                            <!-- NUEVOS CAMPOS: Autor y Extensi√≥n (solo lectura) -->
                            <div class="col-md-6">
                                <label class="form-label">Autor</label>
                                <div class="form-control-plaintext">${clasificacion.autor || "-"}</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Extensi√≥n</label>
                                <div class="form-control-plaintext">${doc.extension || "-"}</div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Clasificaci√≥n documental</label>
                                <select class="form-select" id="edit-categoria">
                                    <option value="">Seleccione una opci√≥n</option>
                                    <option value="Administrativa" ${clasificacion.categoria === "Administrativa" ? "selected" : ""}>Administrativa</option>
                                    <option value="Legal" ${clasificacion.categoria === "Legal" ? "selected" : ""}>Legal</option>
                                    <option value="Financiera" ${clasificacion.categoria === "Financiera" ? "selected" : ""}>Financiera</option>
                                    <option value="T√©cnica" ${clasificacion.categoria === "T√©cnica" ? "selected" : ""}>T√©cnica</option>
                                    <option value="Comercial" ${clasificacion.categoria === "Comercial" ? "selected" : ""}>Comercial</option>
                                    <option value="Hist√≥rica" ${clasificacion.categoria === "Hist√≥rica" ? "selected" : ""}>Hist√≥rica</option>
                                    <option value="Operativa" ${clasificacion.categoria === "Operativa" ? "selected" : ""}>Operativa</option>
                                </select>
                                <div id="manual-info" class="info-box"></div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Nivel de confidencialidad</label>
                                <select class="form-select" id="edit-confidencialidad">
                                    <option value="">Seleccione una opci√≥n</option>
                                    <option value="P√∫blica" ${clasificacion.confidencialidad === "P√∫blica" ? "selected" : ""}>P√∫blica</option>
                                    <option value="Uso interno" ${clasificacion.confidencialidad === "Uso interno" ? "selected" : ""}>Uso interno</option>
                                    <option value="Confidencial" ${clasificacion.confidencialidad === "Confidencial" ? "selected" : ""}>Confidencial</option>
                                    <option value="Reservada" ${clasificacion.confidencialidad === "Reservada" ? "selected" : ""}>Reservada</option>
                                    <option value="Secreta" ${clasificacion.confidencialidad === "Secreta" ? "selected" : ""}>Secreta</option>
                                </select>
                                <div id="conf-info" class="info-box"></div>
                            </div>

                            <div class="col-12 d-flex gap-2">
                                <button type="submit" class="btn btn-warning flex-fill">üíæ Guardar clasificaci√≥n</button>
                                <button type="button" id="volver-editar" class="btn btn-secondary flex-fill" style="display:none;">üîô Volver a editar</button>
                            </div>
                        </form>
                        <div id="edit-msg" class="mt-3"></div>
                      </div>
                    </div>
                  </div>
                </div>
            </div>
        `;

        // --- Info de ayuda (manuales y confidencialidad) ---
        const manualInfo = {
            "Administrativa": "Documentos relacionados con la gesti√≥n interna, como memorandos, circulares, actas.",
            "Legal": "Contratos, convenios, resoluciones, normativas.",
            "Financiera": "Facturas, presupuestos, informes contables.",
            "T√©cnica": "Manuales, planos, especificaciones t√©cnicas.",
            "Comercial": "Propuestas, cotizaciones, estudios de mercado.",
            "Hist√≥rica": "Documentos que tienen valor patrimonial o de archivo permanente.",
            "Operativa": "Registros de procesos, reportes de producci√≥n, bit√°coras."
        };

        const confInfo = {
            "P√∫blica": "Acceso libre. No requiere protecci√≥n especial.",
            "Uso interno": "Solo personal autorizado dentro de la organizaci√≥n.",
            "Confidencial": "Informaci√≥n sensible que puede afectar operaciones si se divulga. Requiere controles de acceso.",
            "Reservada": "Informaci√≥n cr√≠tica. Su divulgaci√≥n puede tener consecuencias legales o estrat√©gicas.",
            "Secreta": "Acceso extremadamente restringido. Usada en entornos gubernamentales o militares."
        };

        // ---- obtener elementos reci√©n renderizados ----
        const categoriaSelect = document.getElementById("edit-categoria");
        const confidSelect = document.getElementById("edit-confidencialidad");
        const manualBox = document.getElementById("manual-info");
        const confBox = document.getElementById("conf-info");
        const volverBtn = document.getElementById("volver-editar");
        const guardarBtn = document.querySelector("#editar-clasificacion-form button[type='submit']");
        const editMsg = document.getElementById("edit-msg");

        // Mostrar descripci√≥n cuando el usuario seleccione
        categoriaSelect.addEventListener("change", () => {
            const val = categoriaSelect.value;
            manualBox.style.display = val ? "block" : "none";
            manualBox.innerHTML = val ? `<b>${val}:</b> ${manualInfo[val]}` : "";
        });

        confidSelect.addEventListener("change", () => {
            const val = confidSelect.value;
            confBox.style.display = val ? "block" : "none";
            confBox.innerHTML = val ? `<b>${val}:</b> ${confInfo[val]}` : "";
        });

        // --- GUARDAR CLASIFICACI√ìN ---
        document.getElementById("editar-clasificacion-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = document.getElementById("doc-id-edit").value;
            const categoria = categoriaSelect.value;
            const confidencialidad = confidSelect.value;

            const resp2 = await fetch(`${API_BASE}/documentos/versiones/reclasificar/${id}`, {
                method: "PUT",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ categoria, confidencialidad })
            });

            if (resp2.ok) {
                const resData = await resp2.json();
                editMsg.innerHTML = `
                    <div class="alert alert-success mt-3">
                        ‚úÖ ${resData.mensaje}<br>
                        <strong>Clasificaci√≥n:</strong> ${categoria || '-'}<br>
                        <strong>Confidencialidad:</strong> ${confidencialidad || '-'}
                    </div>
                `;
                categoriaSelect.disabled = true;
                confidSelect.disabled = true;
                guardarBtn.disabled = true;
                volverBtn.style.display = "inline-block";
            } else {
                const err = await resp2.json().catch(()=>({detail:"Error desconocido"}));
                editMsg.innerHTML = `<div class="alert alert-danger">‚ùå ${err.detail || "Error al actualizar"}</div>`;
            }
        });

        // --- VOLVER A EDITAR ---
        volverBtn.addEventListener("click", () => {
            categoriaSelect.disabled = false;
            confidSelect.disabled = false;
            guardarBtn.disabled = false;
            volverBtn.style.display = "none";
            editMsg.innerHTML = "";
        });

    } else {
        resultado.innerHTML = `
            <div class="alert alert-danger">
                ‚ö†Ô∏è Error: ${data.detail || "No se pudo procesar la URL"}
            </div>
        `;
    }
});

// --- LOGOUT ---
document.getElementById("logout-btn").addEventListener("click", () => {
    localStorage.removeItem("access_token");
    localStorage.removeItem("usuario_nombre");
    location.reload();
});

// --- VOLVER AL DASHBOARD ---
document.getElementById("back-btn").addEventListener("click", () => {
    window.location.href = "/dashboard";
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>